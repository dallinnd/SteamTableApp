<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steam Properties PWA</title>
    
    <link rel="manifest" href="manifest.json">

    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        h1 { margin: 0 0 10px 0; font-size: 1.5rem; text-align: center; }
        h2 { margin: 0 0 15px 0; font-size: 1.1rem; border-bottom: 2px solid var(--bg); padding-bottom: 8px; }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .row {
            display: flex;
            gap: 10px;
        }

        input, select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: #fff;
        }

        input { flex: 2; }
        select { flex: 1; }

        button#calc-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button#calc-btn:active { opacity: 0.8; }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .result-item {
            background: var(--bg);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .result-label { font-size: 0.8rem; color: #64748b; margin-bottom: 4px; }
        .result-value { font-size: 1.1rem; font-weight: bold; color: var(--primary); }
        .unit { font-size: 0.8rem; color: #64748b; }

        #error-msg {
            color: #ef4444;
            text-align: center;
            font-weight: bold;
            min-height: 1.5em;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="card">
            <h1>Steam Calculator</h1>
            
            <div class="input-group">
                <label>Temperature</label>
                <div class="row">
                    <input type="number" id="temp_input" placeholder="Enter value">
                    <select id="temp_unit">
                        <option value="C">°C</option>
                        <option value="F">°F</option>
                        <option value="K">K</option>
                        <option value="R">°R</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label>Pressure</label>
                <div class="row">
                    <input type="number" id="press_input" placeholder="Enter value">
                    <select id="press_unit">
                        <option value="bar">bar</option>
                        <option value="psi">psi</option>
                        <option value="kPa">kPa</option>
                        <option value="MPa">MPa</option>
                    </select>
                </div>
            </div>

            <div id="error-msg"></div>

            <button id="calc-btn" py-click="calculate_properties">Calculate</button>
        </div>

        <div class="card">
            <h2>Results</h2>
            <div class="result-grid">
                <div class="result-item">
                    <div class="result-label">Enthalpy (H)</div>
                    <div class="result-value"><span id="res_h">-</span> <span class="unit">kJ/kg</span></div>
                </div>
                <div class="result-item">
                    <div class="result-label">Spec. Volume (V or q)</div>
                    <div class="result-value"><span id="res_v">-</span> <span class="unit">m³/kg</span></div>
                </div>
                <div class="result-item">
                    <div class="result-label">Int. Energy (U)</div>
                    <div class="result-value"><span id="res_u">-</span> <span class="unit">kJ/kg</span></div>
                </div>
                <div class="result-item">
                    <div class="result-label">Entropy (S)</div>
                    <div class="result-value"><span id="res_s">-</span> <span class="unit">kJ/(kg·K)</span></div>
                </div>
            </div>
        </div>
    </div>

    <py-config>
        packages = ["pyXSteam"]
    </py-config>

    <script type="py">
        from pyXSteam.XSteam import XSteam
        from pyscript import document

        # Initialize Steam Table with BARE units (m, kg, sec, K, MPa, W)
        steamTable = XSteam(XSteam.UNIT_SYSTEM_BARE)

        def to_kelvin(val, unit):
            if unit == 'C': return val + 273.15
            if unit == 'F': return (val - 32) * (5/9) + 273.15
            if unit == 'R': return val * (5/9)
            return val # Already K

        def to_mpa(val, unit):
            if unit == 'kPa': return val / 1000.0
            if unit == 'bar': return val * 0.1
            if unit == 'psi': return val * 0.00689476
            return val # Already MPa

        def calculate_properties(event):
            try:
                # Clear errors
                document.getElementById("error-msg").innerText = ""

                # Get inputs
                t_in = float(document.getElementById("temp_input").value)
                p_in = float(document.getElementById("press_input").value)
                
                t_unit = document.getElementById("temp_unit").value
                p_unit = document.getElementById("press_unit").value

                # Convert to BARE System (K and MPa)
                t_k = to_kelvin(t_in, t_unit)
                p_mpa = to_mpa(p_in, p_unit)

                # Calculate State (p, t)
                # Note: h_pt, v_pt etc expect Pressure then Temp
                h = steamTable.h_pt(p_mpa, t_k)
                v = steamTable.v_pt(p_mpa, t_k)
                u = steamTable.u_pt(p_mpa, t_k)
                s = steamTable.s_pt(p_mpa, t_k)

                # Update UI (Round to 4 decimals for precision)
                document.getElementById("res_h").innerText = f"{h:.4f}"
                document.getElementById("res_v").innerText = f"{v:.6f}"
                document.getElementById("res_u").innerText = f"{u:.4f}"
                document.getElementById("res_s").innerText = f"{s:.4f}"

            except ValueError:
                document.getElementById("error-msg").innerText = "Please enter valid numbers."
            except Exception as e:
                document.getElementById("error-msg").innerText = f"Error: {str(e)}"
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(console.error);
        }
    </script>
</body>
</html>
